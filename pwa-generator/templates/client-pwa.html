<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="{{ theme_color }}">
    <title>{{ app_name }}</title>
    
    <!-- Base URL for relative links -->
    <base href="/pwa/{{ provider.pwa_subdomain }}/">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Icons -->
    {% if pwa_config.icon_url %}
    <link rel="icon" href="{{ pwa_config.icon_url }}">
    <link rel="apple-touch-icon" href="{{ pwa_config.icon_url }}">
    {% else %}
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“±</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“±</text></svg>">
    {% endif %}
    
    <!-- Styles -->
    <link rel="stylesheet" href="client-styles.css?v={{ cache_version|default('1') }}">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div id="app">
        <!-- Loading Screen -->
        <div id="loadingScreen" class="loading-screen">
            <div class="loading-spinner"></div>
            <p>Loading {{ app_name }}...</p>
        </div>

        <!-- Authentication Screen -->
        <div id="authScreen" class="auth-screen" style="display: none;">
            <div class="auth-container">
                <div class="auth-header">
                    <div class="app-logo">
                        {% if logo_url %}
                        <img src="{{ logo_url }}" alt="{{ app_name }}" class="logo-img">
                        {% else %}
                        <div class="logo-placeholder">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                        {% endif %}
                    </div>
                    <h1>{{ app_name }}</h1>
                    <p>Access your appointments and providers</p>
                </div>

                <!-- Registration Form (for invitation token) -->
                <div id="registrationForm" class="auth-form">
                    <h2>Create Your Account</h2>
                    <form id="registerForm">
                        <div class="form-group">
                            <label for="regPassword">Create Password</label>
                            <input type="password" id="regPassword" required minlength="8">
                            <div class="password-requirements">
                                <small>Password must be at least 8 characters long</small>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="confirmPassword">Confirm Password</label>
                            <input type="password" id="confirmPassword" required>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-user-plus"></i>
                            Create Account
                        </button>
                    </form>
                </div>

                <!-- Login Form -->
                <div id="loginForm" class="auth-form" style="display: none;">
                    <h2>Welcome Back</h2>
                    <form id="loginFormElement">
                        <div class="form-group">
                            <label for="loginEmail">Email</label>
                            <input type="email" id="loginEmail" required>
                        </div>
                        <div class="form-group">
                            <label for="loginPassword">Password</label>
                            <input type="password" id="loginPassword" required>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-sign-in-alt"></i>
                            Sign In
                        </button>
                    </form>
                    <div class="auth-switch">
                        <p>Don't have an account? <a href="#" onclick="showRegistration()">Create one</a></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main App Screen -->
        <div id="mainApp" class="main-app" style="display: none;">
            <!-- Header -->
            <header class="app-header">
                <div class="header-content">
                    <div class="header-left">
                        {% if logo_url %}
                        <img src="{{ logo_url }}" alt="{{ app_name }}" class="header-logo">
                        {% endif %}
                        <div class="header-info">
                            <h1 class="app-title">{{ app_name }}</h1>
                            <p class="welcome-text">Welcome back, <span id="clientName">Client</span>!</p>
                        </div>
                    </div>
                    <div class="header-right">
                        <button class="btn-icon" onclick="toggleNotifications()">
                            <i class="fas fa-bell"></i>
                            <span class="notification-badge" id="notificationBadge" style="display: none;"></span>
                        </button>
                        <button class="btn-icon" onclick="showUserMenu()">
                            <i class="fas fa-user-circle"></i>
                        </button>
                    </div>
                </div>
            </header>

            <!-- Navigation -->
            <nav class="bottom-nav">
                <button class="nav-item active" onclick="showTab('dashboard')" data-tab="dashboard">
                    <i class="fas fa-home"></i>
                    <span>Home</span>
                </button>
                <button class="nav-item" onclick="showTab('appointments')" data-tab="appointments">
                    <i class="fas fa-calendar"></i>
                    <span>Appointments</span>
                </button>
                <button class="nav-item" onclick="showTab('providers')" data-tab="providers">
                    <i class="fas fa-building"></i>
                    <span>Providers</span>
                </button>
                <button class="nav-item" onclick="showTab('profile')" data-tab="profile">
                    <i class="fas fa-user"></i>
                    <span>Profile</span>
                </button>
            </nav>

            <!-- Main Content -->
            <main class="main-content">
                <!-- Dashboard Tab -->
                <div id="dashboard" class="tab-content active">
                    <div class="dashboard-grid">
                        <!-- Quick Stats -->
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-calendar-check"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="totalAppointments">0</h3>
                                <p>Total Appointments</p>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="upcomingCount">0</h3>
                                <p>Upcoming</p>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-building"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="providersCount">0</h3>
                                <p>Providers</p>
                            </div>
                        </div>

                        <!-- Recent Activity -->
                        <div class="activity-card">
                            <h3>Recent Activity</h3>
                            <div id="recentActivity" class="activity-list">
                                <!-- Activities will be loaded here -->
                            </div>
                        </div>

                        <!-- Quick Actions -->
                        <div class="quick-actions">
                            <h3>Quick Actions</h3>
                            <div class="action-buttons">
                                <button class="action-btn" onclick="quickBookAppointment()">
                                    <i class="fas fa-plus"></i>
                                    Book Appointment
                                </button>
                                <button class="action-btn" onclick="viewNextAppointment()">
                                    <i class="fas fa-eye"></i>
                                    Next Appointment
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Appointments Tab -->
                <div id="appointments" class="tab-content">
                    <div class="tab-header">
                        <h2>My Appointments</h2>
                        <button class="btn btn-primary" onclick="showBookingForm()">
                            <i class="fas fa-plus"></i>
                            Book New
                        </button>
                    </div>
                    
                    <div class="filter-tabs">
                        <button class="filter-tab active" onclick="filterAppointments('all')" data-filter="all">
                            All
                        </button>
                        <button class="filter-tab" onclick="filterAppointments('upcoming')" data-filter="upcoming">
                            Upcoming
                        </button>
                        <button class="filter-tab" onclick="filterAppointments('past')" data-filter="past">
                            Past
                        </button>
                    </div>

                    <div id="appointmentsList" class="appointments-list">
                        <!-- Appointments will be loaded here -->
                    </div>
                </div>

                <!-- Providers Tab -->
                <div id="providers" class="tab-content">
                    <div class="tab-header">
                        <h2>My Providers</h2>
                    </div>
                    
                    <div id="providersList" class="providers-list">
                        <!-- Providers will be loaded here -->
                    </div>
                </div>

                <!-- Profile Tab -->
                <div id="profile" class="tab-content">
                    <div class="profile-section">
                        <div class="profile-header">
                            <div class="profile-avatar">
                                <i class="fas fa-user-circle"></i>
                            </div>
                            <div class="profile-info">
                                <h2 id="profileName">Client Name</h2>
                                <p id="profileEmail">client@example.com</p>
                            </div>
                        </div>

                        <div class="profile-stats">
                            <div class="profile-stat">
                                <span class="stat-number" id="profileTotalAppointments">0</span>
                                <span class="stat-label">Appointments</span>
                            </div>
                            <div class="profile-stat">
                                <span class="stat-number" id="profileProviders">0</span>
                                <span class="stat-label">Providers</span>
                            </div>
                            <div class="profile-stat">
                                <span class="stat-number" id="memberSince">2024</span>
                                <span class="stat-label">Member Since</span>
                            </div>
                        </div>

                        <div class="profile-actions">
                            <button class="profile-btn" onclick="editProfile()">
                                <i class="fas fa-edit"></i>
                                Edit Profile
                            </button>
                            <button class="profile-btn" onclick="changePassword()">
                                <i class="fas fa-lock"></i>
                                Change Password
                            </button>
                            <button class="profile-btn danger" onclick="logout()">
                                <i class="fas fa-sign-out-alt"></i>
                                Sign Out
                            </button>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- Install Prompt -->
        <div id="installPrompt" class="install-prompt" style="display: none;">
            <div class="install-content">
                <div class="install-icon">
                    <i class="fas fa-download"></i>
                </div>
                <div class="install-text">
                    <h3>Install {{ app_name }}</h3>
                    <p>Add to your home screen for quick access</p>
                </div>
                <div class="install-actions">
                    <button id="dismissInstallBtn" class="btn btn-secondary">
                        Later
                    </button>
                    <button id="installAppBtn" class="btn btn-primary">
                        Install
                    </button>
                </div>
            </div>
        </div>

        <!-- Toast Notifications -->
        <div id="toastContainer" class="toast-container"></div>
    </div>

    <!-- Scripts -->
    <script>
        // App Configuration
        window.APP_CONFIG = {
            apiUrl: '{{ api_url }}',
            organizationId: {{ organization_id }},
            themeColor: '{{ theme_color }}',
            accentColor: '{{ accent_color }}',
            features: {
                notifications: {{ features.notifications|lower }},
                offlineMode: {{ features.offline_mode|lower }},
                locationAccess: {{ features.location_access|lower }}
            }
        };
        
        // URL parameters for invitation token
        const urlParams = new URLSearchParams(window.location.search);
        const invitationToken = urlParams.get('token');
        if (invitationToken) {
            window.APP_CONFIG.invitationToken = invitationToken;
        }
    </script>
    <script src="client-app.js?v={{ cache_version|default('1') }}"></script>
    
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => {
                        console.log('SW registered: ', registration);
                    })
                    .catch(registrationError => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
    </script>
</body>
</html>
